<%- include('../header'); %>
<!-- BEGIN breadcrumb -->
<ol class="breadcrumb float-xl-end">
  <li class="breadcrumb-item"><a href="javascript:;">Home</a></li>
  <li class="breadcrumb-item active">회원</li>
</ol>
<!-- END breadcrumb -->
<!-- BEGIN page-header -->
<h1 class="page-header mb-3">회원 <% if (s_label) __append(`<small>${s_label}</small>`)%></h1>
<!-- END page-header -->

<div class="row">
  <div class="col-12">
    <!-- BEGIN panel -->
    <div class="panel panel-inverse">
      <!-- BEGIN panel-heading -->
      <div class="panel-heading">
        <h4 class="panel-title">
          리스트
          <a href="javascript:;" onclick="wasUtils.addUserInfo()" class="btn btn-success btn-xs d-inline-block ms-2">신규회원 <i class="fa fa-plus"></i></a>
        </h4>
        <div class="panel-heading-btn">
          <a href="javascript:;" class="btn btn-xs btn-icon btn-default" data-toggle="panel-expand"><i class="fa fa-expand"></i></a>          
          <a href="javascript:;" class="btn btn-xs btn-icon btn-warning" data-toggle="panel-collapse"><i class="fa fa-minus"></i></a>
        </div>
      </div><!-- END panel-heading -->
      <form method="get" name="listForm" id="listForm" autocomplete="off" action="javascript:;;">
      <input type="hidden" name="s_label" value="<%=s_label%>">      
      <input type="hidden" name="s_page" value="<%=s_page%>">   
      <input type="hidden" name="s_order" value="<%=s_order%>">
      <input type="hidden" name="s_orderdir" value="<%=s_orderdir%>">
      <!-- BEGIN panel-body -->
      <div class="panel-body"> 
        <div class="row">
          <div class="col-sm-6">
            <div class="panel-tools-item">
              <select name="s_pagecnt" class="form-select form-select-sm w-sm-auto me-sm-2">
              <% 
                for(let el of s_pageArray) {
                  let selected = (el == s_pagecnt)?'selected':'';
                  __append(`<option value="${el}" ${selected}>${el}</option> `);
                }
              %>
              </select> 
              <label class="w-sm-auto text-end">개씩보기</label>
            </div>
          </div>
          <div class="col-sm-6 mb-2">
            <div class="panel-tools-item justify-content-end">
              <select name="s_key" class="form-select form-select-sm w-sm-auto me-sm-2">
              <% 
                for(let el in s_keyArray) {                    
                  let selected = (el == s_key)?'selected':'';
                  __append(`<option value="${el}" ${selected}>${s_keyArray[el]}</option> `);
                }
              %>                
              </select>               
              <div class="input-group input-group-sm input-search-group">
                <input type="text" name="s_value" id="s_value" class="form-control" value="<%=s_value%>" placeholder="검색어">
                <button type="button" class="btn btn-indigo" onclick="appUtils.page_search()"><i class="fas fa-search"></i> 검색</button>
                <button type="button" class="btn btn-default dropdown-toggle" data-bs-toggle="dropdown" data-bs-auto-close="outside"><span class="caret"></span></button>
                <div class="dropdown-menu dropdown-menu-end">
                  <div class="form-group dropdown-item">
                    <label>빠른메뉴</label>
                    <select name="s_quick" class="form-select form-select-sm">
                      <% 
                        for(let el in s_quickArray) {                    
                          let selected = (el == s_quick)?'selected':'';
                          __append(`<option value="${el}" ${selected}>${s_quickArray[el]}</option> `);
                        }
                      %>                          
                    </select>
                  </div>
                  <div class="form-group dropdown-item">
                    <label>상태</label>
                    <select name="s_status" class="form-select form-select-sm">                      
                      <%                                               
                        for(let el in s_statusArray) {                                       
                          let selected = (el == s_status)?'selected':'';
                          __append(`<option value="${el}" ${selected}>${s_statusArray[el]}</option> `);
                        }
                      %>                          
                    </select>
                  </div>                             
                  <div class="form-group dropdown-item">                    
                    <label>시작일</label>
                    <input type="text" class="form-control form-control-sm dtpicker" placeholder="시작일" name="s_sdate" value="<%=s_sdate%>">
                  </div>                  
                  <div class="form-group dropdown-item">                    
                    <label>종료일</label>
                    <input type="text" class="form-control form-control-sm dtpicker" placeholder="종료일" name="s_edate" value="<%=s_edate%>">
                  </div>                  
                  <div class="dropdown-item">
                    <div class="d-inline-block"><span class="btn btn-sm btn-default" onclick="appUtils.page_init()">리셋</span></div>
                    <div class="d-inline-block float-end"><span class="btn btn-sm btn-indigo" onclick="appUtils.page_search()">검색</span></div>
                  </div>
                  <div class="dropdown-divider"></div>
                  <div class="form-group dropdown-item">
                    <a href="javascript:;" class="btn btn-secondary btn-sm d-block" onclick="exportExcel(this)"><i class="fa-solid fa-file-excel"></i> 엑셀다운로드</a>
                  </div>
                  <div class="form-group dropdown-item">
                    <a href="javascript:;" class="btn btn-secondary btn-sm d-block" onclick="exportPrint(this)"><i class="fa-solid fa-print"></i> 프린트</a>
                  </div>
								</div>                
              </div>
            </div>
          </div>
        </div><!--//.row-->
        <div class="row">
          <div class="col-sm-12 table-responsive">
            <table class="table dataTable table-striped table-hover table-bordered align-middle">
              <thead>              
                <tr>
                  <th class="text-nowrap w10">
                    <input type="checkbox" onchange="$('input[name=history_id]').prop('checked', this.checked);">
                  </th>                  
                  <th class="text-nowrap sorting <%-h.misc.checkOrder('A.f_name', s_order, s_orderdir)%>" data-order="A.f_name" onclick="wasUtils.setOrder(this)">이름</th>
                  <th class="text-nowrap sorting <%-h.misc.checkOrder('A.f_email', s_order, s_orderdir)%>" data-order="A.f_email" onclick="wasUtils.setOrder(this)">이메일</th>
                  <th class="text-nowrap">추천인</th>
                  <th class="text-nowrap">누적수수료 <i class="fa-solid fa-receipt text-danger" data-toggle="tooltip" title="발생한 누적 수수료"></i></th>
                  <th class="text-nowrap">누적배당 <i class="fa-solid fa-receipt text-danger" data-toggle="tooltip" title="지금까지 받은 배당"></i></th>
                  <th class="text-nowrap">보유</th>                  
                  <th class="text-nowrap sorting <%-h.misc.checkOrder('A.id', s_order, s_orderdir)%>" data-order="A.id" onclick="wasUtils.setOrder(this)">가입일</th>
                  <th class="text-nowrap">기능</th>
                </tr>
              </thead>
              <tbody>
              <% if (!list || list.length == 0 ) { %>
                <tr>
                  <td class="text-center h-50px" colspan="15">
                    데이터가 존재하지 않습니다.
                  </td>
                </tr>
                <% 
                  } else { 
                    list.forEach(function(el, index) {
                %>
                <tr>
                  <td>
                    <input type="checkbox" name="useridx" value="<%-el.idx%>">
                  </td>
                  <td class="text-end"><%=el.f_name%></td>
                  <td><%=el.f_email%></td>
                  <td><%=el.f_referralemail%></td>
                  <td class="text-end">
                    <%-h.misc.setFormatNumberWithPlacesSmall(el.f_sumfee, 2, true)%>
                  </td>
                  <td class="text-end">
                    <%-h.misc.setFormatNumberWithPlacesSmall(el.f_sumcoms, 2, true)%>
                  </td>
                  <td class="text-end">
                    <%-h.misc.setFormatNumberWithPlacesSmall(el.f_balance, 2, true)%>
                  </td>
                  <td class="text-center">          
                    <%=h.misc.formatDateTime(el.f_regAt)%>
                  </td>
                  <td class="text-center" style="width:60px">
                    <a href="javascript:;;" class="btn btn-xs btn-outline-danger me-2 mb-1 text-nowrap" onclick="wasUtils.setUserInfo(<%=el.idx%>);">
                      <i class="fa-solid fa-pen-to-square"></i> 수정
                    </a>                    
                  </td>
                </tr>
                <%                      
                    });
                  }
                %>
              </tbody>
            </table>
          </div>
        </div><!-- //.row-->
        <div class="row pt-2">
          <div class="col-sm-5">
            <%=`총 ${h.misc.setFormatNumber(totalcnt)}개중 ${h.misc.setFormatNumber(pagesnum)}부터 ${h.misc.setFormatNumber(pageenum>totalcnt?totalcnt:pageenum)}까지 출력중`%>
          </div>
          <div class="col-sm-7">
            <%-pagination%>
          </div>
        </div>        
      </div><!-- END panel-body -->
      </form>
    </div><!-- END panel -->
  </div><!-- //.col-->
</div><!-- //.row-->

<div id="FrmUserInfo" class="d-none">
  <form role="form" name="user-editor" method="post" enctype="multipart/form-data">
    <input type="hidden" name="useridx">    
    <div class="row">
      <div class="col-md-6">
        <div class="row mb-10px">
          <div class="col-12">
            <label class="form-label">Email</label>
            <input type="email" name="f_email" data-vali='{"fMail":"이메일"}' class="form-control" placeholder="이메일" value="">
          </div>            
        </div>
        <div class="row mb-10px">
          <div class="col-12">
            <label class="form-label">Name</label>
            <input type="text" name="f_name" data-vali='{"fNam":"이름"}' class="form-control" placeholder="이름" value="">
          </div>
        </div>
        <div class="row mb-10px">
          <div class="col-12">
            <label class="form-label">Referral Email</label>
            <input type="text" name="f_referralemail" class="form-control" placeholder="추천인 이메일" value="">
          </div>
        </div>        
        <div class="row mb-10px">
          <div class="col-6">
            <label class="form-label">Token Name</label>
            <input type="text" name="f_token" class="form-control" disabled value="">
          </div>
          <div class="col-6">
            <label class="form-label">Token Network</label>
            <input type="text" name="f_tnetwork" class="form-control" disabled value="">
          </div>
        </div>

        <div class="row mb-10px">
          <div class="col-12">
            <label class="form-label">Token Address</label>
            <input type="text" name="f_taddress" class="form-control" value="">
          </div>
        </div>
        <div class="row mb-10px">
          <div class="col-12">
            <label class="form-label">New Password</label>
            <input type="password" name="password" class="form-control">
          </div>
        </div>

        <div class="row mb-10px">
          <div class="col-12">
            <label class="form-label">Conditions</label>
            <div>
              <div class="form-check form-check-inline">              
                <label class="form-check-label"><input class="form-check-input" type="radio" name="f_status" value="1"> 미등록</label>
              </div>
              <div class="form-check form-check-inline">              
                <label class="form-check-label"><input class="form-check-input" type="radio" name="f_status" value="2"> 활성</label>
              </div>
              <div class="form-check form-check-inline">              
                <label class="form-check-label"><input class="form-check-input" type="radio" name="f_status" value="3"> 미활성</label>
              </div>
              <div class="form-check form-check-inline">              
                <label class="form-check-label"><input class="form-check-input" type="radio" name="f_status" value="9"> 탈퇴</label>
              </div>
            </div>
          </div>          
        </div>
      </div>
      <div class="col-md-6">
        <div class="row h-100">
          <div class="col-12  pb-3">
            <label class="form-label">메모</label>
            <textarea name="f_memo" class="form-control norerezie" style="height: 100%;" value="" ></textarea>
          </div>
        </div>
      </div>      
    </div>
  </form>  
</div><!--//#FrmUserInfo-->

<script>

  function exportExcel(obj) {

    let frm = $(obj).parents('form[name=listForm]').eq(0);

    if (frm) {
      let target = obj.closest('.panel');
      appUtils.showLoading(target);    

      appUtils.ajaxJSON(
        '/api/getUser.json', 
        frm.serialize(), 
        (data) => {          
          console.log(data);
          switch(data['result']) {
            case 100:
              let headers = {
                idx:'순번', 
                empty1:'송금자명', 
                name:'성명', 
                tel:'전화번호', 
                account: '이메일',
                accountholder: '예금주',
                bankname:'은행', 
                bankaccountnumber:'계좌번호', 
                empty2:'요청금액', 
                empty3:'이체메모'
              };

              let list = data.data;

              for(let i = 0; i < list.length; i++) {
                list[i]['idx'] = i + 1;
                list[i]['empty1'] = '';
                list[i]['empty2'] = '';
                list[i]['empty3'] = '';
              }

              appUtils.excelFileExport(list, '회원정보', headers)

              break;
            default:
              alert('잘못된 접근 입니다.');
              break;
          }                  
          appUtils.hideLoading(target);  
        },
        (j) => {
          appUtils.hideLoading(target);
          alert('서버 에러로 실패 하였습니다.');
        });
    }

  }

  function exportPrint(obj) {
    let frm = $(obj).parents('form[name=listForm]').eq(0);

    if (frm) {
      let target = obj.closest('.panel');
      appUtils.showLoading(target);    

      appUtils.ajaxJSON(
        '/api/getUser.json', 
        frm.serialize(), 
        (data) => {          
          switch(data['result']) {
            case 100:

              if (data.data.length > 10000) {
                alert('10,000이 넘는 데이터는 한번에 출력할 수가 없습니다. 엑셀 다운로드를 이용해주세요.');
                appUtils.hideLoading(target);  
                return;
              }

              let headers = {
                idx:'순번', 
                name:'성명', 
                tel:'전화번호', 
                account: '이메일',
                accountholder: '예금주',
                bankname:'은행', 
                bankaccountnumber:'계좌번호', 
                regdate: '등록일'
              };

              let list = data.data;

              for(let i = 0; i < list.length; i++) {
                list[i]['idx'] = i + 1;
              }

              let exportInfo = {
                title: '회원리스트',
                messageTop: '',
                messageBottom: ''
              }

              appUtils.printFileExport(data.data, exportInfo, headers)

              break;
            default:
              alert('잘못된 접근 입니다.');
              break;
          }                  
          appUtils.hideLoading(target);  
        },
        (j) => {
          appUtils.hideLoading(target);
          alert('서버 에러로 실패 하였습니다.');
        });
    }
  }

  function fncChangeIsBan(obj) {
    const frm = $(obj).parents('form[name=user-editor]');
    if ($(obj).is(':checked')) {
      frm.find('input[name=appmemo]').show();
    } else {
      frm.find('input[name=appmemo]').hide();
    }
  }  



  
  function selectCountryCode(code) {
    $(`#country_code`).val(code);
    $('#dropdownMenuButton2').html('+'+code);   
  }


  function doTransfer(account, name, balance) {
    let modal = '#modal-md';

    modalUtils.showmin(modal, '지급', undefined, '취소', '', '지급',
    () => {
      //ok btn
      let frm = $(`${modal} form[name=FrmTransfer]`);
      let balance = appUtils.getNumber(frm.find('span[name=recipientBalance]').text());
      let amount = appUtils.getNumber(frm[0].amount.value);
      let memo = frm[0].memo.value;
      let account = frm[0].user_id.value;

      if (amount <= 0) {
        appUtils.showAlert('잘못된 지급값입니다.');
        return;
      }
      
      modalUtils.disableButton(modal);

      appUtils.ajaxJSON('/user/transfer', {account, amount, memo}, 
        (dt) => {
          if (dt.result == 100) {
            appUtils.swalSuccess('지급되었습니다', ()=>{appUtils.page_reload()});
          } else {
            appUtils.showAlert(dt.msg);   
            modalUtils.enableButton(modal); 
          }          
        }
      );
    },
    () => {
      //before open
      modalUtils.setContent(modal, $('#FrmTransfer').html());
      let frm = $(`${modal} form[name=FrmTransfer]`);
      
      frm.find('p[name=recipientName]').text(name);
      frm.find('p[name=recipientEmail]').text(account);
      frm.find('span[name=recipientBalance]').text(balance);
      frm.find('input[name=user_id]').val(account);      
    });
  }

  function doUndoTransfer(account, name, balance) {
    let modal = '#modal-md';

    modalUtils.showmin(modal, '회수', undefined, '취소', '', '회수',
    () => {
      //ok btn
      let frm = $(`${modal} form[name=FrmUndoTransfer]`);
      let balance = appUtils.getNumber(frm.find('span[name=collectionBalance]').text());
      let amount = appUtils.getNumber(frm[0].amount.value);
      let memo = frm[0].memo.value;
      let account = frm[0].user_id.value;

      if (amount <= 0) {
        appUtils.showAlert('잘못된 전송값입니다.');
        return;
      }

      if (amount > balance) {
        //appUtils.showAlert('잔액보다 회수금액이 큽니다.');
        //return;
      }

      modalUtils.disableButton(modal);

      appUtils.ajaxJSON('/user/undotransfer', {account, amount, memo}, 
        (dt) => {
          if (dt.result == 100) {
            appUtils.swalSuccess('회수되었습니다', ()=>{appUtils.page_reload()});
          } else {
            appUtils.showAlert(dt.msg);   
            modalUtils.enableButton(modal); 
          }          
        }
      );      

    },
    () => {
      //before open
      modalUtils.setContent(modal, $('#FrmUndoTransfer').html());
      let frm = $(`${modal} form[name=FrmUndoTransfer]`);
      
      frm.find('p[name=collectionName]').text(name);
      frm.find('p[name=collectionEmail]').text(account);
      frm.find('span[name=collectionBalance]').text(balance);
      frm.find('input[name=user_id]').val(account);   
    });
  }

  function checkValue(obj) {
    let amount = obj.value;
    console.log(amount);
    return false;
  }

  let prevAmount = 0;

  function calcAmount(id) {
    var amount = $(id).val();

    if (!amount) amount = "0";

    if (amount.search(/^\d*\.?\d{0,2}$/) == -1) {
      amount = prevAmount;
      $(id).val(amount); 
    } else {
      prevAmount = amount;
    }
  }  
</script>

<%- include('../footer'); %>

